<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Connexion Discord — Bridge</title>
  <meta name="robots" content="noindex,nofollow" />
  <style>
    html,body{height:100%; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:#0b1118; color:#e7ecff;}
    .wrap{height:100%; display:flex; align-items:center; justify-content:center; padding:24px;}
    .card{max-width:720px; width:100%; border:1px solid rgba(231,236,255,.12); background:rgba(255,255,255,.03);
      border-radius:16px; padding:18px 18px; box-shadow:0 8px 40px rgba(0,0,0,.35);}
    .h1{font-weight:900; font-size:18px; margin:0 0 8px;}
    .p{opacity:.9; margin:0 0 12px; line-height:1.45;}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; font-size:12px; opacity:.85; white-space:pre-wrap;}
    .row{display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;}
    .btn{appearance:none; border:1px solid rgba(0,229,255,.22); background:rgba(0,229,255,.08); color:rgba(0,229,255,.95);
      font-weight:900; padding:10px 12px; border-radius:999px; cursor:pointer;}
    .btn.secondary{border-color:rgba(231,236,255,.14); background:rgba(255,255,255,.03); color:rgba(231,236,255,.92);}
    .small{font-size:12px; opacity:.75;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="h1">Connexion Discord…</div>
      <p class="p" id="statusLine">Traitement en cours.</p>
      <div class="mono" id="debugLine" style="display:none;"></div>
      <div class="row" id="actions" style="display:none;">
        <button class="btn" id="goHub">Retour au HUB</button>
        <button class="btn secondary" id="clearSession">Effacer la session</button>
      </div>
      <p class="small" style="margin-top:12px;">Cette page sert uniquement de passerelle OAuth (Discord → HUB). Tu peux la garder telle quelle.</p>
    </div>
  </div>

<script>
(() => {
  const USER_KEY = "shog.discord.user";
  const TOKEN_KEY = "shog.discord.token";
  const TOKEN_META_KEY = "shog.discord.token.meta";

  const statusLine = document.getElementById("statusLine");
  const debugLine  = document.getElementById("debugLine");
  const actions    = document.getElementById("actions");

  const goHubBtn   = document.getElementById("goHub");
  const clearBtn   = document.getElementById("clearSession");

  function setStatus(msg){ statusLine.textContent = msg; }
  function showDebug(msg){
    debugLine.style.display = "";
    debugLine.textContent = msg;
  }
  function showActions(){
    actions.style.display = "flex";
  }

  function safeParseB64Json(base64){
    // Worker encodes with: btoa(unescape(encodeURIComponent(str)))
    // Decode with: decodeURIComponent(escape(atob(b64)))
    const json = decodeURIComponent(escape(atob(base64)));
    return JSON.parse(json);
  }

  function cleanUrl(){
    // Remove querystring + hash from history
    try { history.replaceState({}, "", location.pathname); } catch(_) {}
  }

  function redirectToHub(){
    // Redirect to the current HUB (repo renamed to Industriel-calc).
    location.replace("https://shog-sc.github.io/Industriel-calc/");
  }

  // Buttons (fallback)
  goHubBtn.addEventListener("click", redirectToHub);
  clearBtn.addEventListener("click", () => {
    try { localStorage.removeItem(USER_KEY); } catch(_) {}
    try { sessionStorage.removeItem(TOKEN_KEY); } catch(_) {}
    try { sessionStorage.removeItem(TOKEN_META_KEY); } catch(_) {}
    setStatus("Session effacée. Redirection vers le HUB…");
    cleanUrl();
    setTimeout(redirectToHub, 350);
  });

  // Main
  const params = new URLSearchParams(location.search);
  const d = params.get("d"); // IMPORTANT: worker sends ?d=<base64>

  // Token can be provided in hash: #t=<base64> (preferred), or query ?t=...
  const hashRaw = (location.hash || "").startsWith("#") ? location.hash.slice(1) : "";
  const hashParams = new URLSearchParams(hashRaw);
  const t = hashParams.get("t") || params.get("t");

  if(!d){
    setStatus("Aucune donnée reçue. Redirection vers le HUB…");
    cleanUrl();
    setTimeout(redirectToHub, 350);
    return;
  }

  try {
    const user = safeParseB64Json(d);

    // Minimal validation
    if(!user || !user.discordId || !user.username){
      throw new Error("Payload Discord invalide (champs manquants).");
    }

    const storedUser = {
      discordId: String(user.discordId),
      username: String(user.username),
      globalName: user.globalName ?? null,
      avatar: user.avatar ?? null,
      ts: Date.now()
    };

    localStorage.setItem(USER_KEY, JSON.stringify(storedUser));

    // If token provided, store it in sessionStorage for same-tab redirect to HUB.
    if (t) {
      const tok = safeParseB64Json(t);
      if (tok && tok.access_token) {
        sessionStorage.setItem(TOKEN_KEY, String(tok.access_token));
        const meta = {
          token_type: tok.token_type || "Bearer",
          scope: tok.scope || "identify",
          expires_in: tok.expires_in ?? null,
          obtained_at: tok.obtained_at ?? Date.now(),
          expires_at: tok.expires_at ?? null
        };
        sessionStorage.setItem(TOKEN_META_KEY, JSON.stringify(meta));
      }
    }

    const hasToken = !!sessionStorage.getItem(TOKEN_KEY);
    setStatus(`Connecté : ${storedUser.globalName || storedUser.username}. Token: ${hasToken ? "OK" : "ABSENT"} • Redirection vers le HUB…`);
    cleanUrl();
    setTimeout(redirectToHub, 450);
  } catch (e) {
    setStatus("Erreur pendant la connexion. Tu peux retourner au HUB.");
    showDebug(String(e && e.message ? e.message : e));
    showActions();
  }
})();
</script>
</body>
</html>
