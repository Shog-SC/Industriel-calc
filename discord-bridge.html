<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Connexion Discord — Bridge</title>
  <meta name="robots" content="noindex,nofollow" />
  <meta name="referrer" content="no-referrer" />
  <style>
    html,body{height:100%; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:#0b1118; color:#e7ecff;}
    .wrap{height:100%; display:flex; align-items:center; justify-content:center; padding:24px;}
    .card{max-width:780px; width:100%; border:1px solid rgba(231,236,255,.12); background:rgba(255,255,255,.03);
      border-radius:16px; padding:18px 18px; box-shadow:0 8px 40px rgba(0,0,0,.35);}
    .h1{font-weight:900; font-size:18px; margin:0 0 8px;}
    .p{opacity:.9; margin:0 0 12px; line-height:1.45;}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; font-size:12px; opacity:.85; white-space:pre-wrap;}
    .row{display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;}
    .btn{appearance:none; border:1px solid rgba(0,229,255,.22); background:rgba(0,229,255,.08); color:rgba(0,229,255,.95);
      font-weight:900; padding:10px 12px; border-radius:999px; cursor:pointer;}
    .btn.secondary{border-color:rgba(231,236,255,.14); background:rgba(255,255,255,.03); color:rgba(231,236,255,.92);}
    .small{font-size:12px; opacity:.75;}
    code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; font-size:12px;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="h1">Connexion Discord…</div>
      <p class="p" id="statusLine">Traitement en cours.</p>
      <div class="mono" id="debugLine" style="display:none;"></div>
      <div class="row" id="actions" style="display:none;">
        <button class="btn" id="goHub">Retour</button>
        <button class="btn secondary" id="clearSession">Effacer la session</button>
      </div>
      <p class="small" style="margin-top:12px;">
        Bridge OAuth : stocke l'utilisateur (<code>localStorage: shog.discord.user</code>) et, si fourni, le token (<code>sessionStorage: shog.discord.token</code>), puis redirige.
      </p>
    </div>
  </div>

<script>
(() => {
  const STORAGE_USER_KEY = "shog.discord.user";
  const STORAGE_TOKEN_KEY = "shog.discord.token";
  const STORAGE_TOKEN_META_KEY = "shog.discord.token.meta";
  const STORAGE_RETURN_TO = "shog.returnTo";

  const statusLine = document.getElementById("statusLine");
  const debugLine  = document.getElementById("debugLine");
  const actions    = document.getElementById("actions");

  const goHubBtn   = document.getElementById("goHub");
  const clearBtn   = document.getElementById("clearSession");

  function setStatus(msg){ statusLine.textContent = msg; }
  function showDebug(msg){
    debugLine.style.display = "";
    debugLine.textContent = msg;
  }
  function showActions(){ actions.style.display = "flex"; }

  function safeAtobJson(b64){
    // Worker encodes with: btoa(unescape(encodeURIComponent(str)))
    // Decode with: decodeURIComponent(escape(atob(b64)))
    const json = decodeURIComponent(escape(atob(b64)));
    return JSON.parse(json);
  }

  function parseParams(){
    const out = new URLSearchParams(location.search);
    // Merge hash params too (preferred for tokens)
    if (location.hash && location.hash.length > 1) {
      const hp = new URLSearchParams(location.hash.slice(1));
      for (const [k, v] of hp.entries()) out.set(k, v);
    }
    return out;
  }

  function cleanUrl(){
    try { history.replaceState({}, "", location.pathname); } catch(_) {}
  }

  function redirectToReturnTo(){
    const fallback = "https://shog-sc.github.io/Industriel-calc/";
    let target = fallback;
    try {
      const rt = sessionStorage.getItem(STORAGE_RETURN_TO);
      if (rt && /^https?:\/\//i.test(rt)) target = rt;
      sessionStorage.removeItem(STORAGE_RETURN_TO);
    } catch(_) {}
    location.replace(target);
  }

  goHubBtn.addEventListener("click", redirectToReturnTo);
  clearBtn.addEventListener("click", () => {
    try { localStorage.removeItem(STORAGE_USER_KEY); } catch(_) {}
    try { sessionStorage.removeItem(STORAGE_TOKEN_KEY); } catch(_) {}
    try { sessionStorage.removeItem(STORAGE_TOKEN_META_KEY); } catch(_) {}
    setStatus("Session effacée. Redirection…");
    cleanUrl();
    setTimeout(redirectToReturnTo, 250);
  });

  const params = parseParams();

  // User payload (base64 JSON) expected in d
  const d = params.get("d");
  // Token payload can be:
  //  - raw access_token in t
  //  - base64 JSON in t (ex: {access_token, token_type, scope, expires_in, expires_at})
  //  - direct OAuth implicit: access_token in hash (#access_token=...)
  const t = params.get("t") || null;
  const accessTokenFromHash = params.get("access_token") || null;

  if (!d) {
    setStatus("Aucune donnée reçue. Redirection…");
    cleanUrl();
    setTimeout(redirectToReturnTo, 350);
    return;
  }

  try {
    const user = safeAtobJson(d);

    if (!user || !user.discordId || !user.username) {
      throw new Error("Payload Discord invalide (champs manquants)." );
    }

    const storedUser = {
      discordId: String(user.discordId),
      username: String(user.username),
      globalName: (user.globalName ?? null),
      avatar: (user.avatar ?? null),
      ts: Date.now()
    };

    localStorage.setItem(STORAGE_USER_KEY, JSON.stringify(storedUser));

    // Token handling
    // Priority: implicit hash access_token, else t
    const rawToken = accessTokenFromHash || t;
    if (rawToken) {
      let token = null;
      let meta = null;

      // Try base64 JSON first
      try {
        const obj = safeAtobJson(rawToken);
        if (obj && typeof obj === "object") {
          token = (obj.access_token || obj.token || null);
          meta = {
            token_type: obj.token_type || "Bearer",
            scope: obj.scope || null,
            expires_in: obj.expires_in || null,
            expires_at: obj.expires_at || null,
            ts: Date.now()
          };
        }
      } catch(_) {
        // Not base64 JSON — assume raw token string
        token = String(rawToken);
        meta = { token_type: "Bearer", scope: null, expires_in: null, expires_at: null, ts: Date.now() };
      }

      if (token) {
        sessionStorage.setItem(STORAGE_TOKEN_KEY, token);
        sessionStorage.setItem(STORAGE_TOKEN_META_KEY, JSON.stringify(meta));
      }
    }

    const hasToken = !!sessionStorage.getItem(STORAGE_TOKEN_KEY);

    setStatus(`Connecté : ${storedUser.globalName || storedUser.username}. ${hasToken ? "Token OK. " : "(Token absent : SaveRuns indisponible tant que l'OAuth ne le transmet pas.) "}Redirection…`);
    cleanUrl();
    setTimeout(redirectToReturnTo, 450);

  } catch (e) {
    setStatus("Erreur pendant la connexion. Tu peux retourner." );
    showDebug(String(e && e.message ? e.message : e));
    showActions();
  }
})();
</script>
</body>
</html>
